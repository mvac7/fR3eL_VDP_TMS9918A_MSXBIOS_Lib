/* =============================================================================
# TestTMS

- Version: 1.4 (24/07/2025)
- Author: mvac7/303bcn
- Architecture: MSX
- Format: 16K ROM
- Programming language: C and Z80 assembler
- Compiler: SDCC 4.4 or newer

## Description:
Perform a test of the functions of the VDP TMS9918A library for MSX ROM 
environment.

## History of versions:
- v1.4 (24/07/2025) 
	- Changes to resemble the VDP_TMS9918A library test application
- v1.3 ( 1/12/2023) update to SDCC (4.3). For v1.5 library
- v1.2 (13/ 4/2018)
============================================================================= */

// ---------------------------------------------------------------------------- Includes
#include "../include/newTypes.h"
#include "../include/msxSystemVariables.h"
#include "../include/msxBIOS.h"

#include "../include/keyboard_MSX.h"
#include "../include/VDP_TMS9918A_MSXBIOS.h"



#define  HALT __asm halt __endasm   //wait for the next interrupt

#define WAIT_TIME 100

// ---------------------------------------------------------------------------- Labels




// ---------------------------------------------------------------------------- Function Declaration
void WAIT(uint cicles);
char INKEY(void);
void LOCATE(char x, char y);

char GetVFrequency(void);

boolean isTxtMode(void);
boolean isSPRITE16px(void);

void VLOCATE(char column, char line);
void VPRINT(char* text);

void DrawHorzLine(char tile, char size);
void DrawBox(char width, char height);
void DrawFillBox(char width, char height, char tile);

void ClearVRAM(void);

void ShowMenu(void);
void Menu(void);


void PressKey(void);

void TestVDP(void);

void testSCREEN0(void);
void testSCREEN1(void);
void testSCREEN2(void);
void testSCREEN3(void);

void testCLS(void);
void testFill(void);
void testVpeekVpoke(void);

void setSpritesPatterns(void);
void showSprites(char offset);
void initSprites(void);

void testSprites(void);
void testSpritePosition(void);
void testSpriteColor(void);
void testSpritePattern(void);
void testSpriteVisible(void);




// ---------------------------------------------------------------------------- Constants
const char text00[] = "MSX fR3eL SDCC Libraries";
const char text01[] = "Test VDP_TMS9918A_MSXBIOS Lib"; 
const char text10[] = ">Test CLS()";

const char textMENU[5][30] = {
"[F1] Test TEXT1     (Screen0)",
"[F2] Test GRAPHIC1  (Screen1)",
"[F3] Test GRAPHIC2  (Screen2)",
"[F4] Test MULTICOLOR(Screen3)",
"[F5] Test Sprites            "};

const char textVers[4][7] = {"MSX1","MSX2","MSX2+","turboR"};
const char textVFreq[2][5] = {"NTSC","PAL"};
const char CheckResult[2][8] = {"=ERROR!","=Ok    "};

const char msg_PressKey[] = "Press any key to continue";


// ---------------------------------------------------------
// tMSgfX devtool v0.9.16.0
// Tileset Pattern Data - Mode:G1
// Tiles range: 0 to 127
// Size=1024
const char font01Bold_sc06x8_PAT[]={
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xAA,0x55,0xAA,0x55,0xAA,0x55,0xAA,0x55,
0x00,0x01,0x03,0x07,0x0F,0x1F,0x3F,0x7F,
0x80,0xC0,0xE0,0xF0,0xF8,0xFC,0xFE,0xFF,
0x7F,0x3F,0x1F,0x0F,0x07,0x03,0x01,0x00,
0xFF,0xFE,0xFC,0xF8,0xF0,0xE0,0xC0,0x80,
0x01,0x02,0x04,0x08,0x10,0x20,0x40,0x80,
0x80,0x40,0x20,0x10,0x08,0x04,0x02,0x01,
0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,
0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x18,0x18,0x18,0xFF,0xFF,0x00,0x00,0x00,
0x00,0x00,0x00,0xFF,0xFF,0x18,0x18,0x18,
0x18,0x18,0x18,0xF8,0xF8,0x18,0x18,0x18,
0x18,0x18,0x18,0x1F,0x1F,0x18,0x18,0x18,
0x18,0x18,0x18,0xFF,0xFF,0x18,0x18,0x18,
0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,
0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,
0x00,0x00,0x00,0x0F,0x1F,0x18,0x18,0x18,
0x00,0x00,0x00,0xF0,0xF8,0x18,0x18,0x18,
0x18,0x18,0x18,0x1F,0x0F,0x00,0x00,0x00,
0x18,0x18,0x18,0xF8,0xF0,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x30,0x30,0x30,0x30,0x00,0x30,0x00,
0x00,0x50,0x50,0x00,0x00,0x00,0x00,0x00,
0x00,0x50,0xF8,0x50,0xF8,0x50,0x00,0x00,
0x20,0xF8,0xA0,0xF8,0x28,0xF8,0x20,0x00,
0x00,0xCC,0xD8,0x30,0x6C,0xCC,0x00,0x00,
0x00,0x60,0xB0,0xF4,0xD8,0xF4,0x00,0x00,
0x00,0x30,0x60,0x00,0x00,0x00,0x00,0x00,
0x18,0x30,0x30,0x30,0x30,0x30,0x18,0x00,
0x30,0x18,0x18,0x18,0x18,0x18,0x30,0x00,
0x00,0xB4,0x78,0xFC,0x78,0xB4,0x00,0x00,
0x00,0x30,0x30,0xFC,0x30,0x30,0x00,0x00,
0x00,0x00,0x00,0x00,0x30,0x30,0x20,0x00,
0x00,0x00,0x00,0xF8,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x30,0x30,0x00,0x00,
0x00,0x0C,0x18,0x30,0x60,0xC0,0x00,0x00,
0x70,0xD8,0xD8,0xD8,0xD8,0x70,0x00,0x00,
0x30,0x70,0x30,0x30,0x30,0x78,0x00,0x00,
0xF0,0x18,0x70,0xC0,0xC0,0xF8,0x00,0x00,
0xF0,0x18,0x70,0x18,0x18,0xF0,0x00,0x00,
0xD8,0xD8,0xF8,0x18,0x18,0x18,0x00,0x00,
0xF8,0xC0,0xF0,0x18,0x18,0xF0,0x00,0x00,
0x70,0xC0,0xF0,0xD8,0xD8,0x70,0x00,0x00,
0xF8,0x18,0x30,0x60,0x60,0x60,0x00,0x00,
0x70,0xD8,0x70,0xD8,0xD8,0x70,0x00,0x00,
0x70,0xD8,0xD8,0x78,0x18,0x70,0x00,0x00,
0x00,0x30,0x30,0x00,0x30,0x30,0x00,0x00,
0x00,0x30,0x30,0x00,0x30,0x30,0x20,0x00,
0x00,0x18,0x30,0x60,0x30,0x18,0x00,0x00,
0x00,0x00,0x78,0x00,0x78,0x00,0x00,0x00,
0x00,0x60,0x30,0x18,0x30,0x60,0x00,0x00,
0x78,0xCC,0x0C,0x18,0x30,0x00,0x30,0x00,
0x78,0x84,0xB4,0xD4,0xBC,0x80,0x78,0x00,
0x70,0xD8,0xD8,0xF8,0xD8,0xD8,0x00,0x00,
0xF0,0xD8,0xF0,0xD8,0xD8,0xF0,0x00,0x00,
0x78,0xC0,0xC0,0xC0,0xC0,0x78,0x00,0x00,
0xF0,0xD8,0xD8,0xD8,0xD8,0xF0,0x00,0x00,
0xF8,0xC0,0xF0,0xC0,0xC0,0xF8,0x00,0x00,
0xF8,0xC0,0xF0,0xC0,0xC0,0xC0,0x00,0x00,
0x70,0xC0,0xC0,0xD8,0xD8,0x78,0x00,0x00,
0xD8,0xD8,0xF8,0xD8,0xD8,0xD8,0x00,0x00,
0x60,0x60,0x60,0x60,0x60,0x60,0x00,0x00,
0x30,0x30,0x30,0x30,0x30,0xE0,0x00,0x00,
0xD8,0xD8,0xF0,0xD8,0xD8,0xD8,0x00,0x00,
0xC0,0xC0,0xC0,0xC0,0xC0,0xF8,0x00,0x00,
0x88,0xD8,0xF8,0xF8,0xD8,0xD8,0x00,0x00,
0x98,0xD8,0xF8,0xF8,0xD8,0xC8,0x00,0x00,
0x70,0xD8,0xD8,0xD8,0xD8,0x70,0x00,0x00,
0xF0,0xD8,0xD8,0xD8,0xF0,0xC0,0x00,0x00,
0x70,0xD8,0xD8,0xD8,0xD0,0x68,0x00,0x00,
0xF0,0xD8,0xD8,0xF0,0xD8,0xD8,0x00,0x00,
0x78,0xC0,0xF0,0x78,0x18,0xF0,0x00,0x00,
0x78,0x30,0x30,0x30,0x30,0x30,0x00,0x00,
0xD8,0xD8,0xD8,0xD8,0xD8,0x70,0x00,0x00,
0xD8,0xD8,0xD8,0xD8,0x70,0x20,0x00,0x00,
0xD8,0xD8,0xD8,0xF8,0xD8,0x88,0x00,0x00,
0xD8,0xD8,0x70,0x70,0xD8,0xD8,0x00,0x00,
0xCC,0xCC,0xCC,0x78,0x30,0x30,0x00,0x00,
0xF8,0x18,0x30,0x60,0xC0,0xF8,0x00,0x00,
0x38,0x30,0x30,0x30,0x30,0x30,0x38,0x00,
0x00,0xC0,0x60,0x30,0x18,0x0C,0x00,0x00,
0x70,0x30,0x30,0x30,0x30,0x30,0x70,0x00,
0x20,0x70,0xD8,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0xFC,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x70,0x18,0x78,0xD8,0xF8,0x00,0x00,
0xC0,0xF0,0xC8,0xC8,0xC8,0xF0,0x00,0x00,
0x00,0x78,0xC0,0xC0,0xC0,0x78,0x00,0x00,
0x18,0x78,0xD8,0xD8,0xD8,0x78,0x00,0x00,
0x00,0x70,0xD8,0xF8,0xC0,0x70,0x00,0x00,
0x38,0x60,0x60,0xF8,0x60,0x60,0x00,0x00,
0x00,0x70,0xD8,0xD8,0x78,0x18,0xF0,0x00,
0xC0,0xF0,0xD8,0xD8,0xD8,0xD8,0x00,0x00,
0x30,0x00,0x30,0x30,0x30,0x30,0x00,0x00,
0x30,0x00,0x30,0x30,0x30,0x30,0xE0,0x00,
0xC0,0xD8,0xD8,0xF0,0xD8,0xD8,0x00,0x00,
0x30,0x30,0x30,0x30,0x30,0x30,0x00,0x00,
0x00,0xF0,0xA8,0xA8,0xA8,0xA8,0x00,0x00,
0x00,0xF0,0xD8,0xD8,0xD8,0xD8,0x00,0x00,
0x00,0x70,0xD8,0xD8,0xD8,0x70,0x00,0x00,
0x00,0xF0,0xD8,0xD8,0xD8,0xF0,0xC0,0x00,
0x00,0x78,0xD8,0xD8,0xD8,0x78,0x18,0x00,
0x00,0x78,0xC0,0xC0,0xC0,0xC0,0x00,0x00,
0x00,0x78,0xC0,0x70,0x18,0xF0,0x00,0x00,
0x60,0xF8,0x60,0x60,0x60,0x38,0x00,0x00,
0x00,0xD8,0xD8,0xD8,0xD8,0x70,0x00,0x00,
0x00,0xD8,0xD8,0xD8,0x70,0x20,0x00,0x00,
0x00,0xD8,0xD8,0xA8,0xF8,0xA8,0x00,0x00,
0x00,0xD8,0x70,0x20,0x70,0xD8,0x00,0x00,
0x00,0xD8,0xD8,0xD8,0x78,0x18,0xF0,0x00,
0x00,0xF8,0x18,0x30,0x60,0xF8,0x00,0x00,
0x18,0x30,0x30,0x60,0x30,0x30,0x18,0x00,
0x30,0x30,0x30,0x00,0x30,0x30,0x30,0x00,
0x60,0x30,0x30,0x18,0x30,0x30,0x60,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};


// Tileset Color Data - Mode:G1
// Size=32
const char font01Bold_sc06x8_COL[]={
0x74,0x74,0x74,0x74,0xF4,0xF4,0xF4,0xF4,
0xF4,0xF4,0xF4,0xF4,0xF4,0xF4,0xF4,0xF4,
0x00,0x11,0x22,0x33,0x44,0x55,0x66,0x77,
0x88,0x99,0xAA,0xBB,0xCC,0xDD,0xEE,0xFF};


// Tileset Color Data - Mode:G1
// Size=32
const char tileset_06x8_COL2[]={
0x94,0x94,0x34,0x34,0xB4,0xB4,0x74,0x74,
0xF4,0xF4,0xF4,0xF4,0xE4,0xE4,0xE4,0xE4,
0xFD,0xE4,0xF5,0xE7,
0xEC,0xF2,0xE3,0xFA,
0xF6,0xE8,0xF9,0xEB,
0xE1,0xFE,0xEF,0xF0};


const char sprcol[16]={
12, 2, 3, 7,
 6, 8, 9,14,
 3,10,12,11,
13, 9,10,15};


// ---------------------------------------------------------
// tMSgfX devtool v0.9.16.0
// Project: TestTMS_sprites.PNG
// ---------------------------------------------------------
// SpriteSet Pattern Data - Size=16x16 - Mode=Mode1 Monocolor
// Sprite range: 0 to 9
// Size=320
const char SPRITE_DATA[]={
0x3C,0x42,0xA5,0x81,0xA5,0x99,0x42,0x3C,
0x3C,0x7E,0xDB,0xFF,0xFF,0xDB,0x66,0x3C,
0x6C,0xFE,0xFE,0xFE,0x7C,0x38,0x10,0x00,
0x10,0x38,0x7C,0xFE,0x7C,0x38,0x10,0x00,
0x10,0x38,0x54,0xFE,0x54,0x10,0x38,0x00,
0x10,0x38,0x7C,0xFE,0xFE,0x10,0x38,0x00,
0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,
0xFF,0xFF,0xFF,0xE7,0xE7,0xFF,0xFF,0xFF,
0x0F,0x1F,0x3D,0x3F,0x7B,0x7C,0xBF,0xBF,
0x9F,0xEF,0x6F,0x1F,0x0F,0x05,0x05,0x1D,
0xC0,0xE0,0x60,0xC0,0x40,0x80,0x80,0x84,
0x86,0xDE,0xC0,0xC0,0x80,0x00,0x00,0xC0,
0x05,0x07,0x1A,0x2E,0x6F,0x5B,0x5C,0x5B,
0x5F,0x58,0x6F,0x2D,0x16,0x02,0x02,0x06,
0x40,0xC0,0xB8,0xD4,0xD4,0x6A,0xEA,0x6A,
0xEA,0x6A,0xD4,0xD4,0xF8,0x40,0x40,0x60,
0x03,0x07,0x4F,0xCF,0x4D,0x4F,0x2C,0x1E,
0x3F,0x3F,0x3F,0x3F,0x1F,0x02,0x02,0x06,
0xC0,0xE2,0xE6,0xE2,0xA2,0xF4,0x38,0x7C,
0xFE,0xFE,0xFE,0xFC,0xF8,0x40,0x40,0x60,
0x05,0x1E,0x3F,0x6F,0x57,0x6E,0x3F,0x00,
0x07,0x05,0x07,0x04,0x06,0x03,0x02,0x06,
0x60,0xF8,0xF4,0xEA,0x76,0xBE,0x7C,0x00,
0xE0,0x60,0xE0,0x20,0x60,0xC0,0x40,0x60,
0x05,0x07,0x1F,0x3F,0x7F,0x7F,0x7F,0x7D,
0x7F,0x7F,0x78,0x3F,0x1F,0x04,0x04,0x0C,
0x40,0xC0,0xF0,0xF8,0xFC,0xFC,0xFC,0x7C,
0xFC,0xFC,0x3C,0xF8,0xF0,0x40,0x40,0x60,
0x07,0x1F,0x3F,0x3F,0x7F,0x71,0x7F,0x7F,
0x7F,0x7E,0x3E,0x3F,0x1F,0x07,0x02,0x06,
0xE0,0xF8,0xFC,0xFC,0xFE,0x8E,0xFE,0xFE,
0xFE,0x7E,0x7C,0xFC,0xF8,0xE0,0x40,0x60,
0x00,0x07,0x1F,0x3F,0x7F,0x71,0xFF,0xFF,
0x7B,0x7C,0x3F,0x1F,0x07,0x02,0x02,0x06,
0x00,0xE0,0xF8,0xFC,0xFE,0x8E,0xFF,0xFF,
0xDE,0x3E,0xFC,0xF8,0xE0,0x40,0x40,0x60,
0x05,0x1E,0x3F,0x6F,0x57,0x6E,0x3F,0x00,
0x07,0x05,0x07,0x04,0x06,0x03,0x02,0x06,
0x60,0xF8,0xF4,0xEA,0x76,0xBE,0x7C,0x00,
0xE0,0x60,0xE0,0x20,0x60,0xC0,0x40,0x60};


  
// Sine
// Length=255; Min=16; Max=144; Freq=1; Phase=0
const char SIN[]={
0x50,0x52,0x53,0x55,0x56,0x58,0x59,0x5B,0x5D,0x5E,0x60,0x61,0x63,0x64,0x66,0x67,
0x69,0x6A,0x6B,0x6D,0x6E,0x70,0x71,0x72,0x74,0x75,0x76,0x78,0x79,0x7A,0x7B,0x7C,
0x7D,0x7E,0x80,0x81,0x82,0x83,0x84,0x84,0x85,0x86,0x87,0x88,0x89,0x89,0x8A,0x8B,
0x8B,0x8C,0x8C,0x8D,0x8D,0x8E,0x8E,0x8F,0x8F,0x8F,0x8F,0x90,0x90,0x90,0x90,0x90,
0x90,0x90,0x90,0x90,0x90,0x8F,0x8F,0x8F,0x8F,0x8E,0x8E,0x8E,0x8D,0x8D,0x8C,0x8C,
0x8B,0x8A,0x8A,0x89,0x88,0x87,0x87,0x86,0x85,0x84,0x83,0x82,0x81,0x80,0x7F,0x7E,
0x7D,0x7C,0x7B,0x79,0x78,0x77,0x76,0x74,0x73,0x72,0x70,0x6F,0x6E,0x6C,0x6B,0x69,
0x68,0x66,0x65,0x63,0x62,0x60,0x5F,0x5D,0x5C,0x5A,0x59,0x57,0x56,0x54,0x52,0x51,
0x4F,0x4E,0x4C,0x4A,0x49,0x47,0x46,0x44,0x43,0x41,0x40,0x3E,0x3D,0x3B,0x3A,0x38,
0x37,0x35,0x34,0x32,0x31,0x30,0x2E,0x2D,0x2C,0x2A,0x29,0x28,0x27,0x25,0x24,0x23,
0x22,0x21,0x20,0x1F,0x1E,0x1D,0x1C,0x1B,0x1A,0x19,0x19,0x18,0x17,0x16,0x16,0x15,
0x14,0x14,0x13,0x13,0x12,0x12,0x12,0x11,0x11,0x11,0x11,0x10,0x10,0x10,0x10,0x10,
0x10,0x10,0x10,0x10,0x10,0x11,0x11,0x11,0x11,0x12,0x12,0x13,0x13,0x14,0x14,0x15,
0x15,0x16,0x17,0x17,0x18,0x19,0x1A,0x1B,0x1C,0x1C,0x1D,0x1E,0x1F,0x20,0x22,0x23,
0x24,0x25,0x26,0x27,0x28,0x2A,0x2B,0x2C,0x2E,0x2F,0x30,0x32,0x33,0x35,0x36,0x37,
0x39,0x3A,0x3C,0x3D,0x3F,0x40,0x42,0x43,0x45,0x47,0x48,0x4A,0x4B,0x4D,0x4E,0x50};



// ---------------------------------------------------------------------------- Global Variables
uint vprint_addr;
uint time;
boolean VDPstatus;

char spr_posX[16];
char spr_posY[16];

char tilesetBakup[1024];



// ---------------------------------------------------------------------------- Functions


//
void main(void)
{
	VDPstatus = true;
	
	Menu();   
}



/* =============================================================================
LOCATE

Description: 
		Moves the cursor to the specified location.
Input:	(char) Position X of the cursor. (0 to 31 or 79)
		(char) Position Y of the cursor. (0 to 23)         
Output:	-
============================================================================= */
void LOCATE(char x, char y) __naked
{
x;
y;
__asm

  inc  A
  ld   H,A

  inc  L
  
  jp BIOS_POSIT

__endasm;
}



// Generates a pause in the execution of n interruptions.
// PAL: 50=1second. ; NTSC: 60=1second. 
void WAIT(uint cicles)
{
  uint i;
  for(i=0;i<cicles;i++) HALT;
}



char PEEK(uint address) __naked
{
address;
__asm

  ld   A,(HL)

  ret		//return A
__endasm;
}



void POKE(uint address, char value)
{
address;value;
__asm
	push IX
	ld   IX,#0
	add  IX,SP

	ld   A,4(IX)
	ld   (HL),A

	pop  IX  
__endasm;
}



void VLOCATE(char column, char line)
{
	if (isTxtMode()) vprint_addr = BASE0+(line*40)+column;	//Text 40col Mode
	else vprint_addr = BASE10+(line*32)+column; 			//GRAPHIC1 or GRAPHIC2 modes
}



void VPRINT(char* text)
{
	while(*(text)) VPOKE(vprint_addr++,*(text++));
}



void DrawHorzLine(char tile, char size)
{
	char i;
	for(i=0;i<size;i++) VPOKE(vprint_addr++,tile);
}



void DrawBox(char width, char height)
{
	char box_winside = width-2;
	char box_hinside = height-2;
	char nextLine;
		
	char i;
	
	if (isTxtMode()) nextLine = 41-width;
	else nextLine = 33-width;
	
	VPOKE(vprint_addr++,24);
	DrawHorzLine(23,box_winside);
	VPOKE(vprint_addr,25);
	vprint_addr+=nextLine;
	
	for(i=1;i<box_hinside;i++)
	{		
		VPOKE(vprint_addr++,22);
		DrawHorzLine(32,box_winside);
		VPOKE(vprint_addr,22);
		vprint_addr+=nextLine;
	}		
	
	VPOKE(vprint_addr++,26);
	DrawHorzLine(23,box_winside);
	VPOKE(vprint_addr++,27);	
}



void DrawFillBox(char width, char height, char tile)
{
	char i;
	char nextLine;
	
	if (isTxtMode()) nextLine = 38-width;
	else nextLine = 30-width;
		
	for(i=0;i<height;i++)
	{
		DrawHorzLine(tile,width);
		vprint_addr+=width+nextLine;
	}
}



/* -----------------------------------------------------------------------------
GetVFrequency

Get Video Frequency 
for ROM (except 48K) or BASIC environments (page 0 = BIOS)
Input:	---
Output:	0=60Hz(NTSC), 1=50Hz(PAL) 
----------------------------------------------------------------------------- */  
char GetVFrequency(void) __naked
{
__asm

; -----------------------------------
	ld   A,(#0x002D)	//MSXVER=002D MSX version number (0=MSX,1=MSX2,2=MSX2+,3=TurboR)
	or   A
	jr   NZ,readHZfromVDP	//IF A!=0
  
//in the MSX1, the information about the video frequency is in a system variable
	ld   A,(#0x002B)	//MSXROM1
	bit  7,A			//Default interrupt frequency (0=60Hz, 1=50Hz)
	jr   Z,VFreq_isNTSC
	jr   VFreq_isPAL   

//If it is run on an MSX2 or higher, we can check the video frequency in the VDP registers
readHZfromVDP:
//look at the system variable that contains the VDP registry value
	ld   A,(0xFFE8)		//(RG9SAV) Mirror of VDP register 9
	bit  1,A			//(0=60Hz, 1=50Hz)  
	jr   Z,VFreq_isNTSC
  
VFreq_isPAL:
	ld   A,#1
	ret
  
VFreq_isNTSC:  
	xor  A
	ret  
__endasm;
}



/* =============================================================================
isTxtMode
Indicates whether Text 1 mode is active.
Output:	1=Yes/True ; 0=No/False
============================================================================= */
boolean isTxtMode(void)
{
	//char VDP1 = *(unsigned int *) 0xF3E0;	//RG1SAV=0xF3E0 (System var)
	return GetVDP(1) & 0b00010000;	
}



boolean isSPRITE16px(void)
{
	char VDP1 = *(unsigned int *) 0xF3E0;	//RG1SAV=0xF3E0 (System var)
	return VDP1 & 0b00000010;
}



void PressKey(void)
{
	VLOCATE(0,23);
	VPRINT(msg_PressKey);
	LOCATE(25,23);
	INKEY();	
}



void ClearVRAM(void)
{	
	FillVRAM(0,0x3FFF,0x00);
}



void Menu(void)
{
	boolean Row6pressed=false;
	boolean Row7pressed=false;
	char keyPressed;
	
	ShowMenu();
	
	while(1)
	{
		HALT;
		time--;
		
		if(time==0)
		{
			testSCREEN0();
			testSCREEN1();
			testSCREEN2();
			testSCREEN3();
			testSprites();
			ShowMenu();
		}			
		
		// Keyboard row 6
		keyPressed = GetKeyMatrix(6);
		if (keyPressed!=0xFF)
		{
			if(Row6pressed==false)
			{
				//if (!(keyPressed&Bit0)) {Row6pressed=true;}; // [SHIFT]
				//if (!(keyPressed&Bit1)) {Row6pressed=true;}; // [CTRL]
				//if (!(keyPressed&Bit2)) {Row6pressed=true;}; // [GRAPH]
				//if (!(keyPressed&Bit3)) {Row6pressed=true;}; // [CAPS]
				//if (!(keyPressed&Bit4)) {Row6pressed=true;}; // [CODE]
				if (!(keyPressed&Bit5)) {Row6pressed=true;testSCREEN0();ShowMenu();}; // [F1]
				if (!(keyPressed&Bit6)) {Row6pressed=true;testSCREEN1();ShowMenu();}; // [F2]
				if (!(keyPressed&Bit7)) {Row6pressed=true;testSCREEN2();ShowMenu();}; // [F3]
			}
		}else Row6pressed=false;
		
		
		// Keyboard row 7
		keyPressed = GetKeyMatrix(7);
		if (keyPressed!=0xFF)
		{
			if(Row7pressed==false)
			{
				if (!(keyPressed&Bit0)) {Row7pressed=true;testSCREEN3();ShowMenu();}; // [F4]
				if (!(keyPressed&Bit1)) {Row7pressed=true;testSprites();ShowMenu();}; // [F5]
				//if (!(keyPressed&Bit2)) {Row7pressed=true;}; // [ESC]
				//if (!(keyPressed&Bit3)) {Row7pressed=true;}; // [TAB]
				//if (!(keyPressed&Bit4)) {Row7pressed=true;}; // [STOP]
				//if (!(keyPressed&Bit5)) {Row7pressed=true;testCOLOR();ShowMenu();}; // [BS]
				//if (!(keyPressed&Bit6)) {Row7pressed=true;ChangeVDPstatus();}; // [SELECT]
				//if (!(keyPressed&Bit7)) {Row7pressed=true;}; // [RETURN]
			}      
		}else Row7pressed=false;
						
	}		
	
}



void ShowMenu(void)
{
	char i;
		
	COLOR(15,0,1);
 	SCREEN(1);
	CopyToVRAM((uint) font01Bold_sc06x8_PAT,G1_PAT,128*8);
	CopyToVRAM((uint) font01Bold_sc06x8_COL,G1_COL,32);
	
	//show color palette
	for(i=0;i<16;i++)
	{
		VLOCATE(i<<1,0);
		DrawFillBox(2,2,128+(8*i));
		VLOCATE(i<<1,22);
		DrawFillBox(2,2,128+(8*i));
	}
	
	VLOCATE(1,3);
	VPRINT(text00); 
	VLOCATE(1,4);
	VPRINT(text01); 
	
	VLOCATE(0,5);
	DrawBox(32,12);
	
	VLOCATE(0,16);
	DrawBox(32,7);
	
	//show menu items	
	for(i=0;i<5;i++)
	{
		VLOCATE(1,6+i);
		VPRINT(textMENU[i]);
	}
			
	VLOCATE(1,17);
	VPRINT("MSX version: ");
	VPRINT(textVers[PEEK(MSXVER)]); //(0=MSX1;1=MSX2;2=MSX2+;3=turboR)
	
	VLOCATE(1,18);
	VPRINT("VDP V.Freq.: ");
	VPRINT(textVFreq[GetVFrequency()]);
	
	time=30*50; //30segs in PAL
}

	
// ############################################################### TEST SCREEN 0
void testSCREEN0(void)
{
	//ClearVRAM();
		
	COLOR(WHITE,DARK_GREEN,0);    
	SCREEN(0);

	CopyToVRAM((uint) font01Bold_sc06x8_PAT,T1_PAT,128*8);
	
	VLOCATE(31,23);
	VPRINT(" SCREEN 0");	
	WAIT(WAIT_TIME);

	testVpeekVpoke();
	WAIT(WAIT_TIME);

	testFill();
	WAIT(WAIT_TIME);
	
	testCLS();
}



// ############################################################### TEST SCREEN 1
void testSCREEN1(void)
{
	uint vaddr;
	char i;
	
	//ClearVRAM();

	COLOR(5,4,1);    
	SCREEN(1);
	CopyToVRAM((uint) font01Bold_sc06x8_PAT,G1_PAT,128*8); 

	VLOCATE(23,23);
	VPRINT(" SCREEN 1");	
	WAIT(WAIT_TIME);

	vaddr=G1_MAP;
	for(i=0;i<255;i++) VPOKE(vaddr++,i);	//print 0>254 tiles
	VPOKE(vaddr,255);		//print 255 tile
	WAIT(WAIT_TIME);

	/* colors
	The BG Colors array defines 32 colors (each 4 bit background, and 4 bit 
	foreground, as in VDP register 7). The colors are assigned to the BG Tiles as
	follows: Tiles 00..07 share the first color, tiles 08..0F share the second 
	color, etc, and tiles F8..FF share the last color.*/
	CopyToVRAM((uint) tileset_06x8_COL2,G1_COL,32);
	//FillVRAM(G1_COL,32,0xF4);
	
	WAIT(WAIT_TIME);

	//test fill VRAM 
	testFill();
	WAIT(WAIT_TIME);
	
	testCLS();
}



// ############################################################### TEST SCREEN 2
void testSCREEN2(void)
{
	//unsigned int i;
	char value=0;
	
	//ClearVRAM();

	COLOR(0,14,1);    
	SCREEN(2);

	//SetVDPtoWRITE(BASE10);
	//for(i=0;i<0x300;i++) FastVPOKE(value++);	//name table in order

	VLOCATE(23,23);
	VPRINT(" SCREEN 2");	
	WAIT(WAIT_TIME);

	//copy to VRAM tileset, only gfx patterns and fill colors
	//bank 0
	HALT;
	CopyToVRAM((uint) font01Bold_sc06x8_PAT,BASE12,128*8);
	FillVRAM(BASE11,128*8,0x96);		//colors (Red)
	
	WAIT(WAIT_TIME);
	
	//test CopyFromVRAM
	VLOCATE(0,5);
	VPRINT("Test CopyFromVRAM()");
	//copy VRAM to RAM
	CopyFromVRAM(BASE12,(uint) tilesetBakup,128*8);
	WAIT(WAIT_TIME);
	
	
	//test CopyToVRAM 
	VLOCATE(0,6);
	VPRINT("Test CopyToVRAM BANK1");
	//copy VRAM to RAM
	CopyToVRAM((uint) tilesetBakup,BASE12+BANK1,128*8);
	FillVRAM(BASE11+BANK1,128*8,0x3C);	//colors (green)
	WAIT(WAIT_TIME);
	
	//test CopyToVRAM 
	VLOCATE(0,7);
	VPRINT("Test CopyToVRAM BANK2");
	//copy VRAM to RAM
	CopyToVRAM((uint) tilesetBakup,BASE12+BANK2,128*8);
	FillVRAM(BASE11+BANK2,128*8,0x54);	//colors (blue)
	
	WAIT(WAIT_TIME);	
	
	//test fill VRAM  
	testFill();
	WAIT(WAIT_TIME);
	
	testCLS();
}



// ############################################################### TEST SCREEN 3
void testSCREEN3(void)
{
	char value=0;
	char i;
	char loopLine;
	uint vaddr;
	
	//ClearVRAM();

	COLOR(0,4,CYAN);
	SCREEN(1);
	CopyToVRAM((uint) font01Bold_sc06x8_PAT,G1_PAT,128*8);
	CopyToVRAM((uint) font01Bold_sc06x8_COL,G1_COL,32);

	VLOCATE(10,11);
	VPRINT("Test SCREEN 3");

	WAIT(200);
	
	FillVRAM(BASE17, 0x600, 0); //clear screen 3 pattern table
	
	COLOR(0,0,BLACK);
	SCREEN(3);	
	//SortMCmap();

	value=0;
	vaddr=BASE17;

	for(i=0;i<192;i++)
	{
		HALT;
		for(loopLine=0;loopLine<8;loopLine++) VPOKE(vaddr++,value++);
	}

	WAIT(WAIT_TIME);
	CLS();
	WAIT(150);
}



void TestVDP(void)
{
	char VDPval_before;
	char VDPval_after;
	boolean testResult;
	
	SCREEN(1);
	VDPval_before = GetVDP(VDP_Mode1);
	
	VLOCATE(0,0);
	VPRINT(">Test SetVDP()");
	WAIT(WAIT_TIME);
	SetVDP(VDP_Mode1,VDPval_before|0b00010000);	//set M1=1
	HALT;
	VDPval_after = GetVDP(VDP_Mode1);
	WAIT(WAIT_TIME);
	SetVDP(VDP_Mode1,VDPval_before);	//restore screen
	HALT;
	testResult=VDPval_after&0b00010000;
	VLOCATE(0,1);
	VPRINT(">Test GetVDP()");
	WAIT(WAIT_TIME);
	VLOCATE(0,2);
	VPRINT(">Test");
	VPRINT(CheckResult[testResult]);
	
	// (VDPval_after&0b00010000) VPRINT(,">Test=Ok");	//VDPval_before != Textmode1 and VDPval_after == Textmode1
	//else VPRINT(0,2,"Test=ERROR!");
		
	PressKey();	
}



void testCLS(void)
{
	unsigned int i;
	unsigned int vaddr;	
	unsigned int vsize;
	boolean testResult=true;
	
	if (isTxtMode()){
		vaddr=T1_MAP;
		vsize=0x3C0;
	}else{
		vaddr=G1_MAP;
		vsize=0x300;
	}
	
	FillVRAM(vaddr, vsize, 2);
	VLOCATE(0,0);
	VPRINT(text10);
 
	WAIT(150);
	
	CLS();
	WAIT(WAIT_TIME);
	
	for(i=0;i<vsize;i++) if(VPEEK(vaddr++)!=0) testResult=false;
		
	VLOCATE(0,0);
	VPRINT(text10);
	VPRINT(CheckResult[testResult]);
	
	WAIT(200);
}



// TEST VPEEK & VPOKE  #########################################################
// copy a bloq using vpeek and vpoke
void testVpeekVpoke(void)
{
	uint vaddr;
	char i;
	char posY=0;
	boolean testResult;
	
	//test VPOKE & VPEEK
	VLOCATE(0,posY);
	VPRINT("Test VPOKE");
	vaddr=BASE0+40;
	for(i=0;i<255;i++)
	{
		HALT;
		VPOKE(vaddr++,i);
	}
	
	//test VPEEK
	vaddr=BASE0+40;
	testResult=true;
	posY+=(256/40)+2;
	VLOCATE(0,posY);
	VPRINT("Test VPEEK");
	for(i=0;i<255;i++){
		if (VPEEK(vaddr++)!=i){testResult=false;break;}
	}
	VPRINT(CheckResult[testResult]);
	WAIT(WAIT_TIME);
}



// TEST FILL  ##################################################################
//fill screen map with a characters range 
void testFill(void)
{
	char i;
	uint vaddr;
	uint size;
	
	if (isTxtMode()){
		vaddr=T1_MAP+10;
		size=942; //Text 40col Mode		
	}else{
		vaddr=G1_MAP+10;
		size=750; //G1 or G2 modes
	}
	
	VLOCATE(0,0);
	VPRINT("FillVRAM()");
	for(i=32;i<95;i++)
	{
		HALT;
		HALT;
		HALT;
		HALT;

		FillVRAM (vaddr, size, i);    
	}  
  
}



// ################################################################ TEST Sprites
void testSprites(void)
{
	char posY=0;
	
	initSprites();
	
	COLOR(0,0,1);
	SCREEN(1);
	CopyToVRAM((uint) font01Bold_sc06x8_PAT,G1_PAT,128*8);
	CopyToVRAM((uint) font01Bold_sc06x8_COL,G1_COL,32);

	
	setSpritesPatterns();

	VLOCATE(0,posY++);
	VPRINT("Test SPRITEs ------------------");  
	WAIT(50);

	// sprites 8x8
	//setupSprites(0,false); //16x16 no zoom
	VLOCATE(0,posY++);
	VPRINT("SetSpritesSize(0) SPRITES 8x8");
	SetSpritesSize(0);
	SetSpritesZoom(false);  
	showSprites(0);
	WAIT(WAIT_TIME);

	// test sprites 16x16
	//setupSprites(1,false);
	VLOCATE(0,posY++);
	VPRINT("SetSpritesSize(1) SPRITES 16x16");
	ClearSprites();
	SetSpritesSize(1);
	setSpritesPatterns();
	showSprites(2);
	WAIT(WAIT_TIME);

	// test sprites 16x16 + zoom  
	//setupSprites(1,true);
	VLOCATE(0,posY++);
	VPRINT("SetSpritesZoom(true) SPRITES x2");
	SetSpritesZoom(true);
	WAIT(WAIT_TIME);


	VLOCATE(0,posY++);
	VPRINT("ClearSprites()");
	ClearSprites();
	WAIT(WAIT_TIME);
	
	setSpritesPatterns();
	VLOCATE(0,posY++);
	VPRINT("PUTSPRITE(plane,x,y,color,patt)");
	showSprites(2);
	WAIT(WAIT_TIME);	

	VLOCATE(0,posY++);
	VPRINT("Visible");
	testSpriteVisible();

	VLOCATE(0,posY++);
	VPRINT("Change Pattern"); 
	testSpritePattern();

	VLOCATE(0,posY++);
	VPRINT("Change Color"); 
	testSpriteColor();

	VLOCATE(0,posY++);
	VPRINT("Change Position");
	testSpritePosition();
	WAIT(WAIT_TIME);

	VLOCATE(0,posY++);
	VPRINT("Set EarlyClock");
	PUTSPRITE(7, spr_posX[7], spr_posY[7], sprcol[7]+0b10000000, 9);
	WAIT(WAIT_TIME);

	VLOCATE(0,posY++);
	VPRINT("Unset EarlyClock");
	PUTSPRITE(7, spr_posX[7], spr_posY[7], sprcol[7], 9);
	
	VLOCATE(0,posY);
	VPRINT("End SPRITE test");	
	WAIT(200);
}



// Copy sprites data from memory to VRAM
void setSpritesPatterns(void)
{
	CopyToVRAM((uint) SPRITE_DATA,BASE14,32*10);
}



void initSprites(void)
{
	char X=0,Y=2;
	char i=0;

	for(i=0;i<16;i++)
	{
		spr_posX[i]=X*32;
		spr_posY[i]=Y*32;
		X++;
		if(X==4)
		{
			X=0;
			Y++;
		}
	}
}




// ############################################################# TEST PUTSPRITE
void showSprites(char offset)
{
	char i=0;
	char sprpat=0;
	
	for(i=0;i<16;i++)
	{
		PUTSPRITE(i, spr_posX[i], spr_posY[i], sprcol[i], sprpat+offset);
		sprpat++;
		if (sprpat>7) sprpat=0;
		WAIT(10);
	}
}



void testSpriteVisible(void)
{
	char i,o;

	for(o=0;o<8;o++)
	{
		for(i=0;i<16;i++)
		{
			if (i==o) PUTSPRITE(i, spr_posX[i], spr_posY[i], sprcol[i], i+2);
			else PUTSPRITE(i, 0, SPRITES_YHIDDEN, 0, 0);  
		}
		WAIT(25);  
	}  
}



// TEST SETSPRITEPATTERN  ######################################################
void testSpritePattern(void)
{
	char i;

	for(i=2;i<10;i++)
	{
		PUTSPRITE(7, spr_posX[7], spr_posY[7], sprcol[7], i);
		WAIT(25);  
	}  
}



// TEST SETSPRITECOLOR  ########################################################
void testSpriteColor(void)
{
	char i;

	for(i=0;i<16;i++)
	{
		PUTSPRITE(7, spr_posX[7], spr_posY[7], i, 9);
		WAIT(25);  
	}  
}



// TEST SETSPRITEPOSITION  #####################################################
void testSpritePosition(void)
{
	uint i=0;
	char gradX = 64;
	char gradY = 0;

	for(i=0;i<660;i++)
	{
		HALT;
		spr_posX[7]=SIN[gradX];
		spr_posY[7]=SIN[gradY];		
		PUTSPRITE(7, spr_posX[7], spr_posY[7], 14, 9);
		gradX++;
		gradY++;
	}
}
